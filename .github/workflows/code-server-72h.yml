name: code-server 72h via Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  code-server:
    runs-on: ubuntu-latest
    timeout-minutes: 4320 # 72 hours

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install code-server
        run: |
          curl -fsSL -L https://coder.com/install.sh | sh

      - name: Start code-server
        env:
          PASSWORD: ${{ secrets.CODE_SERVER_PASSWORD }}
        run: |
          nohup code-server --auth password --bind-addr 127.0.0.1:8080 &

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
          sudo dpkg -i cloudflared.deb

      - name: Configure Cloudflare Tunnel
        env:
          CF_TUNNEL_TOKEN: ${{ secrets.CF_TUNNEL_TOKEN }}
        run: |
          # Log in using the token
          cloudflared tunnel login
          
          # Create a named tunnel (persistent in your Cloudflare account)
          cloudflared tunnel create code-server-tunnel

          # Route the tunnel to your custom domain
          cloudflared tunnel route dns code-server-tunnel coder.mysticgiggle.ely.by

          # Run the tunnel in the background
          nohup cloudflared tunnel run code-server-tunnel --url http://127.0.0.1:8080 &

      - name: Keep runner alive for 72 hours
        run: |
          echo "üöÄ code-server is running at https://coder.mysticgiggle.ely.by for 72 hours."
          for i in $(seq 1 864); do
            echo "‚è±Ô∏è Hour $i of 72 ‚Äî $(date)"
            sleep 300
          done
